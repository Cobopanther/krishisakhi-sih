<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ title or 'Haritha Chat' }}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: "Poppins", Arial, sans-serif; background:
      linear-gradient(160deg, #eafaf1 0%, #d7ffe9 30%, #b7f3d0 60%, #eafaf1 100%);
      min-height: 100vh; display: flex; color: #0f3d2e; }
    .container { width: 100%; display: grid; grid-template-columns: 280px 1fr; }
    .sidebar { padding: 16px; background: rgba(21,85,60,0.08); border-right: 1px solid rgba(21,85,60,0.15); }
    .brand { font-weight: 700; margin-bottom: 12px; }
    .input { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(21,85,60,0.35); margin: 6px 0; }
    .btn { padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(21,85,60,0.35); background: #fff; cursor: pointer; }
    /* Animated toggle switch */
    .switch { position: relative; display: inline-block; width: 56px; height: 30px; vertical-align: middle; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; inset: 0; background: #d1fae5; border: 1px solid rgba(21,85,60,0.35); transition: background 0.25s ease; border-radius: 999px; }
    .slider:before { content: ""; position: absolute; height: 24px; width: 24px; left: 3px; top: 2px; background-color: #fff; border: 1px solid rgba(21,85,60,0.35); transition: transform 0.25s ease; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
    input:checked + .slider { background: linear-gradient(135deg, #22c55e, #16a34a); }
    input:checked + .slider:before { transform: translateX(26px); }
    .main { display: flex; flex-direction: column; height: 100vh; }
    .messages { flex: 1; overflow-y: auto; padding: 20px; }
    .bubble { max-width: 900px; margin: 0 auto 12px auto; display: grid; grid-template-columns: 40px 1fr; gap: 10px; }
    .avatar { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; color: #fff; }
    .avatar.user { background: #22c55e; } .avatar.bot { background: #0ea5a0; }
    .content { background: rgba(255,255,255,0.9); border: 1px solid rgba(21,85,60,0.15); border-radius: 12px; padding: 12px 14px; white-space: pre-wrap; }
    .composer { position: sticky; bottom: 0; padding: 14px; display: flex; justify-content: center; background: linear-gradient(180deg, rgba(255,255,255,0), rgba(255,255,255,0.9) 40%); }
    .composer-inner { width: 100%; max-width: 900px; display: flex; gap: 8px; border: 1px solid rgba(21,85,60,0.2); border-radius: 14px; padding: 8px; background: rgba(255,255,255,0.9); }
    textarea { flex: 1; border: none; outline: none; resize: none; background: transparent; padding: 10px; }
    .send { background: linear-gradient(135deg, #22c55e, #16a34a); color: #fff; border: none; padding: 10px 14px; border-radius: 10px; font-weight: 700; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <div class="brand">Haritha Chat üåø</div>
      <div style="margin-top:8px; display:flex; align-items:center; justify-content: space-between; gap:10px;">
        <div style="font-weight:600;">Malayalam</div>
        <label class="switch" title="Toggle Malayalam">
          <input id="langToggle" type="checkbox" />
          <span class="slider"></span>
        </label>
      </div>
      <button id="newChat" class="btn" style="margin-top:8px">+ New chat</button>
    </aside>

    <div class="main">
      <div class="messages" id="messages">
        <div class="bubble">
          <div class="avatar bot">AI</div>
          <div class="content">Namaskaram! I am your Haritha AI. Ask about crop planning, market prices, irrigation, or Kerala-specific best practices.</div>
        </div>
      </div>
      <div class="composer">
        <form class="composer-inner" id="composerForm">
          <button type="button" id="micBtn" class="btn" title="Speak"><span id="micIcon">üé§</span></button>
          <input type="file" id="imageInput" accept="image/*" multiple style="display:none" />
          <button type="button" id="imageBtn" class="btn" title="Attach images">üñºÔ∏è</button>
          <textarea id="prompt" rows="1" placeholder="Message Haritha‚Ä¶"></textarea>
          <button class="send" type="submit">Send</button>
        </form>
      </div>
      <div id="imagePreview" style="max-width:900px;margin:0 auto 10px auto;display:flex;gap:8px;flex-wrap:wrap;padding:0 14px"></div>
      </div>
    </div>
  </div>

  <script>
    const messagesEl = document.getElementById('messages');
    const formEl = document.getElementById('composerForm');
    const promptEl = document.getElementById('prompt');
    const newChatBtn = document.getElementById('newChat');
    const langToggle = document.getElementById('langToggle');
    const micBtn = document.getElementById('micBtn');
    const micIcon = document.getElementById('micIcon');
    const history = [];
    const imageInput = document.getElementById('imageInput');
    const imageBtn = document.getElementById('imageBtn');
    const previewEl = document.getElementById('imagePreview');

    function getLang() {
      return (langToggle && langToggle.checked) ? 'ml' : 'en';
    }

    function appendMessage(role, text) {
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      const avatar = document.createElement('div');
      avatar.className = 'avatar ' + (role === 'user' ? 'user' : 'bot');
      avatar.textContent = role === 'user' ? 'You' : 'AI';
      const content = document.createElement('div');
      content.className = 'content';
      content.textContent = text;
      bubble.appendChild(avatar);
      bubble.appendChild(content);
      messagesEl.appendChild(bubble);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      return content;
    }

    newChatBtn.addEventListener('click', () => {
      history.length = 0;
      messagesEl.innerHTML = '';
      appendMessage('assistant', 'New chat started. How can I help with your farm today?');
    });

    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = promptEl.value.trim();
      if (!text) return;
      appendMessage('user', text);
      promptEl.value = '';
      const imagesPayload = await collectSelectedImages();
      clearPreview();
      try {
        const resp = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text, history, lang: getLang(), images: imagesPayload })
        });
        if (!resp.ok) {
          const t = await resp.text();
          appendMessage('assistant', `Error ${resp.status}: ${t}`);
          return;
        }
        const json = await resp.json();
        const reply = json.reply || 'No content returned.';
        appendMessage('assistant', reply);
        history.push({ role: 'user', content: text });
        history.push({ role: 'assistant', content: reply });
      } catch (err) {
        appendMessage('assistant', 'Network error: ' + (err?.message || err));
      }
    });

    // --- Voice recording and transcription ---
    let mediaRecorder;
    let chunks = [];
    let isRecording = false;

    async function startRecording() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
      chunks = [];
      mediaRecorder.ondataavailable = (e) => { if (e.data && e.data.size > 0) chunks.push(e.data); };
      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        const form = new FormData();
        form.append('audio', blob, 'audio.webm');
        form.append('lang', getLang());
        try {
          const resp = await fetch('/api/transcribe', { method: 'POST', body: form });
          const j = await resp.json();
          const txt = (j && j.transcript) ? String(j.transcript) : '';
          if (txt) {
            promptEl.value = txt;
            promptEl.focus();
          }
        } catch (e) {
          appendMessage('assistant', 'Transcription error: ' + (e?.message || e));
        } finally {
          isRecording = false;
          micIcon.textContent = 'üé§';
        }
      };
      mediaRecorder.start();
      isRecording = true;
      micIcon.textContent = '‚è∫Ô∏è';
    }

    function stopRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
      }
    }

    micBtn.addEventListener('click', async () => {
      try {
        if (!isRecording) {
          await startRecording();
        } else {
          stopRecording();
        }
      } catch (e) {
        appendMessage('assistant', 'Microphone error: ' + (e?.message || e));
      }
    });

    // --- Image attach & preview ---
    imageBtn.addEventListener('click', () => imageInput.click());

    imageInput.addEventListener('change', async () => {
      clearPreview();
      const files = Array.from(imageInput.files || []).slice(0, 4);
      for (const f of files) {
        const url = URL.createObjectURL(f);
        const img = document.createElement('img');
        img.src = url;
        img.style.maxWidth = '120px';
        img.style.maxHeight = '90px';
        img.style.objectFit = 'cover';
        img.style.border = '1px solid rgba(21,85,60,0.2)';
        img.style.borderRadius = '8px';
        previewEl.appendChild(img);
      }
    });

    async function collectSelectedImages() {
      const files = Array.from(imageInput.files || []).slice(0, 4);
      const out = [];
      for (const f of files) {
        const b64 = await fileToBase64(f);
        out.push({ mime: f.type || 'image/png', data: b64 });
      }
      // reset input for next round
      imageInput.value = '';
      return out;
    }

    function clearPreview() {
      previewEl.innerHTML = '';
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const result = String(reader.result || '');
          const idx = result.indexOf(',');
          resolve(idx >= 0 ? result.slice(idx + 1) : result);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>


