<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ title or 'Haritha Chat' }}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: "Poppins", Arial, sans-serif; background:
      linear-gradient(160deg, #eafaf1 0%, #d7ffe9 30%, #b7f3d0 60%, #eafaf1 100%);
      min-height: 100vh; display: flex; color: #0f3d2e; }
    .container { width: 100%; display: grid; grid-template-columns: 280px 1fr; }
    .sidebar { padding: 16px; background: rgba(21,85,60,0.08); border-right: 1px solid rgba(21,85,60,0.15); }
    .brand { font-weight: 700; margin-bottom: 12px; }
    .input { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(21,85,60,0.35); margin: 6px 0; }
    .btn { padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(21,85,60,0.35); background: #fff; cursor: pointer; }
    .main { display: flex; flex-direction: column; height: 100vh; }
    .messages { flex: 1; overflow-y: auto; padding: 20px; }
    .bubble { max-width: 900px; margin: 0 auto 12px auto; display: grid; grid-template-columns: 40px 1fr; gap: 10px; }
    .avatar { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; color: #fff; }
    .avatar.user { background: #22c55e; } .avatar.bot { background: #0ea5a0; }
    .content { background: rgba(255,255,255,0.9); border: 1px solid rgba(21,85,60,0.15); border-radius: 12px; padding: 12px 14px; white-space: pre-wrap; }
    .composer { position: sticky; bottom: 0; padding: 14px; display: flex; justify-content: center; background: linear-gradient(180deg, rgba(255,255,255,0), rgba(255,255,255,0.9) 40%); }
    .composer-inner { width: 100%; max-width: 900px; display: flex; gap: 8px; border: 1px solid rgba(21,85,60,0.2); border-radius: 14px; padding: 8px; background: rgba(255,255,255,0.9); }
    textarea { flex: 1; border: none; outline: none; resize: none; background: transparent; padding: 10px; }
    .send { background: linear-gradient(135deg, #22c55e, #16a34a); color: #fff; border: none; padding: 10px 14px; border-radius: 10px; font-weight: 700; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <div class="brand">Haritha Chat ðŸŒ¿</div>
      <label>Model</label>
      <select id="model" class="input">
        <option value="gemini-2.0-flash" selected>gemini-2.0-flash</option>
        <option value="gemini-1.5-flash">gemini-1.5-flash</option>
        <option value="gemini-1.5-pro">gemini-1.5-pro</option>
      </select>
      <label>Temperature</label>
      <input id="temp" type="number" step="0.1" min="0" max="1.5" value="0.7" class="input" />
      <div style="margin-top:8px">
        <label style="display:block;margin-bottom:6px">Malayalam</label>
        <label class="btn" style="display:flex;align-items:center;gap:8px;">
          <input id="langToggle" type="checkbox" />
          <span>Use Malayalam (ml)</span>
        </label>
      </div>
      <button id="newChat" class="btn" style="margin-top:8px">+ New chat</button>
    </aside>

    <div class="main">
      <div class="messages" id="messages">
        <div class="bubble">
          <div class="avatar bot">AI</div>
          <div class="content">Namaskaram! I am your Haritha AI. Ask about crop planning, market prices, irrigation, or Kerala-specific best practices.</div>
        </div>
      </div>
      <div class="composer">
        <form class="composer-inner" id="composerForm">
          <button type="button" id="micBtn" class="btn" title="Speak"><span id="micIcon">ðŸŽ¤</span></button>
          <textarea id="prompt" rows="1" placeholder="Message Harithaâ€¦"></textarea>
          <button class="send" type="submit">Send</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    const messagesEl = document.getElementById('messages');
    const formEl = document.getElementById('composerForm');
    const promptEl = document.getElementById('prompt');
    const modelEl = document.getElementById('model');
    const tempEl = document.getElementById('temp');
    const newChatBtn = document.getElementById('newChat');
    const langToggle = document.getElementById('langToggle');
    const micBtn = document.getElementById('micBtn');
    const micIcon = document.getElementById('micIcon');
    const history = [];

    function getLang() {
      return (langToggle && langToggle.checked) ? 'ml' : 'en';
    }

    function appendMessage(role, text) {
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      const avatar = document.createElement('div');
      avatar.className = 'avatar ' + (role === 'user' ? 'user' : 'bot');
      avatar.textContent = role === 'user' ? 'You' : 'AI';
      const content = document.createElement('div');
      content.className = 'content';
      content.textContent = text;
      bubble.appendChild(avatar);
      bubble.appendChild(content);
      messagesEl.appendChild(bubble);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      return content;
    }

    newChatBtn.addEventListener('click', () => {
      history.length = 0;
      messagesEl.innerHTML = '';
      appendMessage('assistant', 'New chat started. How can I help with your farm today?');
    });

    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = promptEl.value.trim();
      if (!text) return;
      appendMessage('user', text);
      promptEl.value = '';
      try {
        const resp = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text, history, model: modelEl.value, temperature: parseFloat(tempEl.value || '0.7'), lang: getLang() })
        });
        if (!resp.ok) {
          const t = await resp.text();
          appendMessage('assistant', `Error ${resp.status}: ${t}`);
          return;
        }
        const json = await resp.json();
        const reply = json.reply || 'No content returned.';
        appendMessage('assistant', reply);
        history.push({ role: 'user', content: text });
        history.push({ role: 'assistant', content: reply });
      } catch (err) {
        appendMessage('assistant', 'Network error: ' + (err?.message || err));
      }
    });

    // --- Voice recording and transcription ---
    let mediaRecorder;
    let chunks = [];
    let isRecording = false;

    async function startRecording() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
      chunks = [];
      mediaRecorder.ondataavailable = (e) => { if (e.data && e.data.size > 0) chunks.push(e.data); };
      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        const form = new FormData();
        form.append('audio', blob, 'audio.webm');
        form.append('lang', getLang());
        try {
          const resp = await fetch('/api/transcribe', { method: 'POST', body: form });
          const j = await resp.json();
          const txt = (j && j.transcript) ? String(j.transcript) : '';
          if (txt) {
            promptEl.value = txt;
            promptEl.focus();
          }
        } catch (e) {
          appendMessage('assistant', 'Transcription error: ' + (e?.message || e));
        } finally {
          isRecording = false;
          micIcon.textContent = 'ðŸŽ¤';
        }
      };
      mediaRecorder.start();
      isRecording = true;
      micIcon.textContent = 'âºï¸';
    }

    function stopRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
      }
    }

    micBtn.addEventListener('click', async () => {
      try {
        if (!isRecording) {
          await startRecording();
        } else {
          stopRecording();
        }
      } catch (e) {
        appendMessage('assistant', 'Microphone error: ' + (e?.message || e));
      }
    });
  </script>
</body>
</html>


