<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Haritha AI Assistant</title>
  <meta name="description" content="Kerala farming assistant chatbot with a green and white gradient theme.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      font-family: "Poppins", Arial, sans-serif;
      background: linear-gradient(160deg, #eafaf1 0%, #d7ffe9 30%, #b7f3d0 60%, #eafaf1 100%);
      display: flex;
      color: #0f3d2e;
    }

    .sidebar {
      width: 260px;
      padding: 16px;
      background: rgba(21, 85, 60, 0.1);
      border-right: 1px solid rgba(21, 85, 60, 0.15);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .brand-logo {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: linear-gradient(135deg, #80ed99, #a7f3d0);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #0d3b2e;
    }

    .brand-title {
      font-weight: 700;
    }

    .new-chat {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px dashed rgba(21, 85, 60, 0.35);
      color: #0f3d2e;
      background: rgba(255,255,255,0.7);
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .new-chat:hover {
      background: rgba(255,255,255,0.95);
    }

    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .header {
      position: sticky;
      top: 0;
      width: 100%;
      padding: 14px 18px;
      background: rgba(255,255,255,0.6);
      border-bottom: 1px solid rgba(21, 85, 60, 0.15);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-title {
      font-weight: 700;
      color: #134e4a;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .settings-btn {
      background: transparent;
      border: 1px solid rgba(21, 85, 60, 0.35);
      color: #0f3d2e;
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 22px 18px 120px 18px;
    }

    .bubble {
      max-width: 760px;
      margin: 0 auto 12px auto;
      display: grid;
      grid-template-columns: 40px 1fr;
      gap: 10px;
      align-items: flex-start;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: #0ea5a0;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }

    .avatar.user { background: #22c55e; }
    .avatar.bot { background: #0ea5a0; }

    .content {
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(21, 85, 60, 0.15);
      border-radius: 12px;
      padding: 12px 14px;
      color: #0f3d2e;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .composer {
      position: fixed;
      left: 260px;
      right: 0;
      bottom: 0;
      padding: 16px 18px;
      background: linear-gradient(180deg, rgba(255,255,255,0), rgba(255,255,255,0.9) 40%);
      display: flex;
      justify-content: center;
    }

    .composer-inner {
      width: 100%;
      max-width: 820px;
      display: flex;
      gap: 10px;
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(21, 85, 60, 0.2);
      border-radius: 14px;
      padding: 8px;
      box-shadow: 0 8px 28px rgba(0,0,0,0.12);
    }

    textarea {
      flex: 1;
      border: none;
      outline: none;
      resize: none;
      padding: 10px 12px;
      background: transparent;
      color: #0f3d2e;
      font-size: 0.95rem;
      max-height: 180px;
    }

    .send {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.12s ease;
    }

    .send:hover { transform: translateY(-1px); }
    .send:active { transform: translateY(0); }

    @media (max-width: 960px) {
      .sidebar { display: none; }
      .composer { left: 0; }
    }

    /* Settings modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.open { display: flex; }

    .modal-card {
      width: 100%;
      max-width: 520px;
      background: #ffffffee;
      border: 1px solid rgba(21,85,60,0.2);
      border-radius: 14px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.2);
      padding: 18px;
    }

    .modal-card h2 { color: #134e4a; margin-bottom: 8px; }
    .modal-card p { color: #0f3d2e; opacity: 0.9; margin-bottom: 12px; }
    .modal-card label { font-weight: 600; color: #0f3d2e; display: block; margin-bottom: 6px; }
    .modal-card input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(21,85,60,0.35);
      background: #fff;
      color: #0f3d2e;
      font-family: inherit;
      margin-bottom: 12px;
    }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
    .btn-secondary, .btn-primary {
      border: none;
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
    }
    .btn-secondary { background: #e8f7ef; color: #134e4a; border: 1px solid rgba(21,85,60,0.2); }
    .btn-primary { background: linear-gradient(135deg, #22c55e, #16a34a); color: #fff; }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-logo" aria-hidden="true">Ha</div>
      <div class="brand-title">Haritha Assistant</div>
    </div>
    <button class="new-chat" id="newChat">+ New chat</button>
    <a class="new-chat" href="home.html">← Back to Home</a>
  </aside>

  <div class="container">
    <header class="header">
      <div class="header-title">Kerala Farming Chat</div>
      <div class="header-actions">
        <button class="settings-btn" id="openSettings">Settings</button>
      </div>
    </header>

    <main class="messages" id="messages" aria-live="polite">
      <div class="bubble">
        <div class="avatar bot" aria-hidden="true">AI</div>
        <div class="content">Namaskaram! I am your Haritha AI. Ask about crop planning, market prices, irrigation, or Kerala-specific best practices.</div>
      </div>
    </main>

    <div class="composer">
      <form class="composer-inner" id="composerForm">
        <textarea id="prompt" rows="1" placeholder="Message Haritha AI…"></textarea>
        <button type="submit" class="send" title="Send">Send</button>
      </form>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="modal-card">
      <h2 id="settingsTitle">API Settings</h2>
      <p>Your API key is saved only in this browser (localStorage). Never share it.</p>
      <label for="apiKey">Google API Key</label>
      <input id="apiKey" type="password" placeholder="sk-..." autocomplete="off">
      <div class="modal-actions">
        <button class="btn-secondary" id="closeSettings">Cancel</button>
        <button class="btn-primary" id="saveSettings">Save</button>
      </div>
    </div>
  </div>

  <script>
    const messagesEl = document.getElementById('messages');
    const formEl = document.getElementById('composerForm');
    const promptEl = document.getElementById('prompt');
    const newChatBtn = document.getElementById('newChat');
    const openSettingsBtn = document.getElementById('openSettings');
    const settingsModal = document.getElementById('settingsModal');
    const apiKeyInput = document.getElementById('apiKey');
    const saveSettingsBtn = document.getElementById('saveSettings');
    const closeSettingsBtn = document.getElementById('closeSettings');

    // Default Google API key (set once, if none saved). Provided by user.
    const DEFAULT_GOOGLE_KEY = 'AIzaSyBdG9vFRT2wp1zU_2UAFZXEbF4Xe4Nw4Do';

    function appendMessage(role, text) {
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      const avatar = document.createElement('div');
      avatar.className = 'avatar ' + (role === 'user' ? 'user' : 'bot');
      avatar.textContent = role === 'user' ? 'You' : 'AI';
      const content = document.createElement('div');
      content.className = 'content';
      content.textContent = text;
      bubble.appendChild(avatar);
      bubble.appendChild(content);
      messagesEl.appendChild(bubble);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      return content;
    }

    function getApiKey() {
      return localStorage.getItem('google_api_key') || '';
    }

    function setApiKey(key) {
      localStorage.setItem('google_api_key', key);
    }

    // Initialize default key on first load (only if none present)
    if (!getApiKey() && DEFAULT_GOOGLE_KEY) {
      setApiKey(DEFAULT_GOOGLE_KEY);
    }

    // Open/close settings
    openSettingsBtn.addEventListener('click', () => {
      apiKeyInput.value = getApiKey();
      settingsModal.classList.add('open');
    });
    closeSettingsBtn.addEventListener('click', () => settingsModal.classList.remove('open'));
    saveSettingsBtn.addEventListener('click', () => {
      setApiKey(apiKeyInput.value.trim());
      settingsModal.classList.remove('open');
    });

    async function streamGeminiReply(userText) {
      const apiKey = getApiKey();
      if (!apiKey) {
        settingsModal.classList.add('open');
        return;
      }

      const targetEl = appendMessage('assistant', '');
      const model = 'gemini-1.5-flash';
      const url = https://generativelanguage.googleapis.com/v1beta/models/${model}:streamGenerateContent?alt=sse&key=${encodeURIComponent(apiKey)};
      const body = {
        systemInstruction: {
          role: 'system',
          parts: [{
            text: 'You are Haritha, a helpful Kerala farming assistant. Be concise, practical, and Kerala-specific. Prefer Malayalam greetings (Namaskaram), but keep the main content in clear English. Offer actionable steps and local crop examples (paddy, coconut, pepper, banana, rubber, spices). Avoid hallucinations and state when unsure.'
          }]
        },
        contents: [
          {
            role: 'user',
            parts: [{ text: userText }]
          }
        ],
        generationConfig: {
          temperature: 0.7
        }
      };

      try {
        const resp = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (!resp.ok || !resp.body) {
          targetEl.textContent = 'Error: Unable to reach Google Gemini API. Check your key and network.';
          return;
        }

        const reader = resp.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let done = false;
        let buffer = '';
        while (!done) {
          const { value, done: readerDone } = await reader.read();
          done = readerDone;
          buffer += decoder.decode(value || new Uint8Array(), { stream: !done });
          const events = buffer.split('\n\n');
          buffer = events.pop();
          for (const ev of events) {
            const lines = ev.split('\n');
            for (const line of lines) {
              const trimmed = line.trim();
              if (!trimmed.startsWith('data:')) continue;
              const data = trimmed.replace(/^data:\s*/, '');
              if (data === '[DONE]') { done = true; break; }
              try {
                const json = JSON.parse(data);
                const parts = json.candidates?.[0]?.content?.parts || [];
                for (const p of parts) {
                  if (p.text) targetEl.textContent += p.text;
                }
              } catch (_) { /* ignore parse issues */ }
            }
          }
        }
      } catch (err) {
        targetEl.textContent = 'Network error: ' + (err?.message || err);
      }
    }

    formEl.addEventListener('submit', function(e) {
      e.preventDefault();
      const text = promptEl.value.trim();
      if (!text) return;
      appendMessage('user', text);
      promptEl.value = '';
      streamGeminiReply(text);
    });

    newChatBtn.addEventListener('click', function() {
      messagesEl.innerHTML = '';
      appendMessage('assistant', 'New chat started. How can I help with your farm today?');
    });
  </script>
</body>
</html>